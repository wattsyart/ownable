@page "/"
@inherits WalletComponent
@inject TokenService TokenService

<PageTitle>Ownable</PageTitle>

<form class="card card-sm">
    <div class="card-body row no-gutters align-items-center">
        <div class="col-auto">
            <i class="oi oi-magnifying-glass h4 text-body"></i>
        </div>
        <div class="col">
            <input @bind-value="@Address" class="form-control form-control-lg form-control-borderless" type="search" placeholder="Enter a contract address">
        </div>
        <div class="col-auto">
            <button @onclick="OnSearchClicked" @onclick:preventDefault="true" @onclick:stopPropagation="true" class="btn btn-lg btn-success">Search</button>
        </div>
    </div>
</form>

@if (Contract != null)
{
    <h2>@Contract.Name (@Contract.Symbol)</h2>

    if (ContractTokens != null)
    {
        foreach (var token in ContractTokens)
        {
            <div class="card card-sm">
                @token.TokenId
            </div>
        }
    }

    if (!string.IsNullOrWhiteSpace(NextPage))
    {
        <button class="btn btn-secondary" @onclick="OnMoreClicked">More (@NextPage)</button>
    }
}

@code
{
    public Contract? Contract { get; set; }
    public List<Received>? ContractTokens { get; set; }
    public string? Address { get; set; }
    public string? NextPage { get; set; }
    public BlockParameter FromBlock { get; set; } = null!;
    public BlockParameter ToBlock { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        HostProvider.SelectedAccountChanged += OnSelectedAccountChanged;
        FromBlock = BlockParameter.CreateEarliest();
        ToBlock = BlockParameter.CreateLatest();
    }

    private Task OnSelectedAccountChanged(string account)
    {
        Logger?.LogInformation("Account changed to {Account}", account);
        return Task.CompletedTask;
    }

    public override void Dispose()
    {
        base.Dispose();

        HostProvider.SelectedAccountChanged -= OnSelectedAccountChanged;
    }

    private async Task OnSearchClicked()
    {
        await FetchMintedTokensAsync();
    }

    private async Task FetchMintedTokensAsync()
    {
        if (!string.IsNullOrWhiteSpace(Address) && HostProvider.Available)
        {
            Logger?.LogInformation("Fetching collection...");

            var web3 = await HostProvider.GetWeb3Async();

            if (Contract == null)
            {
                var contract = new Contract();
                contract.Address = Address;
                contract.Name = await TokenService.TryGetNameAsync<ERC721.NameFunction>(web3, Address, ContractFeatures.SupportsName, ToBlock);
                contract.Symbol = await TokenService.TryGetSymbolAsync<ERC721.SymbolFunction>(web3, Address, ContractFeatures.SupportsSymbol, ToBlock);
                Contract = contract;
            }

            await GetTokenPageAsync(web3);
        }
    }

    private async Task GetTokenPageAsync(IWeb3 web3)
    {
        if (Contract != null && !string.IsNullOrWhiteSpace(Contract.Address))
        {
            var page = await TokenService.GetMintedTokensAsync<ERC721.Transfer>(web3, Contract.Address, FromBlock, ToBlock, CancellationToken.None, NextPage, Logger);
            ContractTokens = page.Value;
            NextPage = page.NextPage;
        }
    }

    private async Task OnMoreClicked()
    {
        var web3 = await HostProvider.GetWeb3Async();
        await GetTokenPageAsync(web3);
    }
}